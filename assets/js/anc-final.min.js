"use strict";function Game(e){this.gameManager_=e,dev&&(this.debugUi=new cast.receiver.games.debug.DebugUI(e))}function loadScriptsNoCache(e){if(0!=e.length){var a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",e.shift()+"?ts="+Date.now()),a.onload=function(){loadScriptsNoCache(e)},document.getElementsByTagName("head")[0].appendChild(a)}}var app=angular.module("AskNCast",["AskNCast.services","ui.router","ngMaterial","chart.js","angular-md5"]),dev=!1;app.config(["$stateProvider","$urlRouterProvider",function(e,a){a.otherwise("/"),e.state("leaderboard",{templateUrl:"views/leaderboard.html"}).state("results",{templateUrl:"views/results.html"}).state("question",{templateUrl:"views/question.html"})}]),app.config(["$mdThemingProvider",function(e){e.theme("default").primaryPalette("grey",{"default":"800"}).accentPalette("red").dark()}]),app.config(["ChartJsProvider",function(e){e.setOptions({colours:["#66BB6A","#EF5350"],responsive:!0}),e.setOptions("Doughnut",{animateScale:!1})}]),Game.prototype.run=function(e){this.gameManager_.updateGameplayState(cast.receiver.games.GameplayState.RUNNING,null),e()},Game.prototype.setDebugUi=function(e){e?this.debugUi.open():this.debugUi.close()},Game.prototype.setGameData=function(e){this.gameManager_.updateGameData(e)},Game.prototype.chooseRandomQuestioner=function(e,a){var t=_.shuffle(this.gameManager_.getConnectedPlayers())[0];e.phase=a.CHOOSING,e.questioner=t.playerData.name,e.questioner_id=t.playerId,e.questioner_avatar=t.playerData.avatar,e.skip_avail=!1,this.setGameData(e)},Game.prototype.setQuestion=function(e,a,t){a.phase=t.VOTING,a.question=e,a.skip_avail=!1,this.setGameData(a)},Game.prototype.addVote=function(e,a,t,n){e[a]={vote:t,prognosis:n}},Game.prototype.calculateVotes=function(e,a,t,n){var s=2,o=1,r=this.getNumberOfYes(e,a),i=this.getWinnersId(e,r);if(_.each(a,function(e){e.playerData.lastPointsWon=0}),_.each(a,function(e){e.playerData.lastPrognosis=0}),this.addLastPrognosisToPlayerData(e,a),i.length>0)angular.forEach(i,function(e){angular.forEach(a,function(a){a.playerId==e&&(a.playerData.score+=s,a.playerData.lastPointsWon=s)})});else{var c=this.getClosersId(e,r);angular.forEach(c,function(e){angular.forEach(a,function(a){a.playerId==e&&(a.playerData.score+=o,a.playerData.lastPointsWon=o)})})}return t.skip_avail=!1,this.setGameData(t),r},Game.prototype.addLastPrognosisToPlayerData=function(e,a){angular.forEach(e,function(e,t){angular.forEach(a,function(a){console.log("---"),console.log(t),console.log(a.playerId),console.log("---"),a.playerId==t&&(a.playerData.lastPrognosis=e.prognosis)})}),console.log(a)},Game.prototype.getNumberOfYes=function(e){var a=0;return angular.forEach(e,function(e,t){"yes"==e.vote&&a++}),a},Game.prototype.getWinnersId=function(e,a){var t=[];return angular.forEach(e,function(e,n){e.prognosis==a&&t.push(n)}),t},Game.prototype.getClosersId=function(e,a){var t=[],n={};angular.forEach(e,function(e,t){n[t]=Math.abs(a-e.prognosis)});var s=_.min(n);return angular.forEach(n,function(e,a){e==s&&t.push(a)}),t},Game.prototype.stop=function(){},loadScriptsNoCache(["https:///www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js","https://www.gstatic.com/cast/sdk/libs/games/1.0.0/cast_games_receiver.js"]),app.controller("leaderboardController",["$scope","cast",function(e,a){e.labels=["Yes","No"],e.datas=[],e.datasQuestions=[];var t=function(){angular.forEach(e.lastQuestions,function(a,t){e.datas.push([a.yes,a.no]),e.datasQuestions.push(a.question)})};t()}]),app.controller("mainController",["$scope","$log","$window","$timeout","$state","cast","md5",function(e,a,t,n,s,o,r){e.window=t,e.connected=0,e.sessionCount=0;var i,c="https://www.gravatar.com/avatar/",u="?s=50&r=g&d=retro";e.players=[];var l={DEBUG_UI:"debugUI",QUESTION:"question",VOTE:"vote",SKIP:"skip"},p={CHOOSING:"choosing",VOTING:"voting"};e.gameData={phase:p.CHOOSING,question:"",questioner:"",questioner_id:"",questioner_avatar:"",skip_avail:!1},e.votes={},e.lastQuestions=[];var g=function(){0==e.connected&&o.finish()},d=function(a){if(!_.isEmpty(a)&&_.size(a)==_.size(o.game.gameManager_.getPlayersInState(t.cast.receiver.games.PlayerState.PLAYING))){var n=o.game.calculateVotes(a,e.players,e.gameData,p),r=_.size(o.game.gameManager_.getPlayersInState(t.cast.receiver.games.PlayerState.PLAYING))-n;e.lastQuestions.push({question:e.gameData.question,yes:n,no:r}),s.go("results"),e.votes={}}};e.geteGamePhase=function(){return p},e.$on(o.SENDER_CONNECTED,function(t,s){a.info("Sender connected: "+JSON.stringify(s)),i&&(e.idle=!1,n.cancel(i),i=null),e.connected++,e.sessionCount++}),e.$on(o.SENDER_DISCONNECTED,function(a,t){e.connected--,0==e.connected&&(e.getSessionCount()<=0?o.finish():(e.idle=!0,i&&n.cancel(i),i=n(g,1e4)))}),e.getSessionCount=function(){return e.sessionCount},e.$on(o.PLAYER_AVAILABLE,function(t,n){dev&&a.debug(n),e.players=e.players.filter(function(e){return e.playerId!==n.playerInfo.playerId}),e.players.push(n.playerInfo),o.game.gameManager_.updatePlayerData(n.playerInfo.playerId,{name:n.requestExtraMessageData.name,score:0,avatar:c+r.createHash(n.playerInfo.playerId)+u}),e.gameData.phase==p.CHOOSING&&1==o.game.gameManager_.getConnectedPlayers().length&&o.game.chooseRandomQuestioner(e.gameData,p)}),e.$on(o.PLAYER_QUIT,function(t,n){dev&&a.debug(n),e.gameData.phase==p.VOTING&&d(e.votes)}),e.$on(o.PLAYER_DROPPED,function(t,n){dev&&a.debug(n),e.gameData.phase==p.VOTING&&d(e.votes)}),e.$on(o.GAME_MESSAGE_RECEIVED,function(t,n){switch(dev&&a.debug(n),n.requestExtraMessageData.type){case l.DEBUG_UI:dev&&o.game.setDebugUi(n.requestExtraMessageData.toggle);break;case l.QUESTION:e.gameData.phase==p.CHOOSING&&e.gameData.questioner_id==n.playerInfo.playerId&&o.game.setQuestion(n.requestExtraMessageData.question,e.gameData,p);break;case l.VOTE:e.gameData.phase==p.VOTING&&o.game.addVote(e.votes,n.playerInfo.playerId,n.requestExtraMessageData.vote,n.requestExtraMessageData.prognosis);break;case l.SKIP:e.gameData.skip_avail}}),e.$watch("gameData.phase",function(e,a){switch(e){case null:break;case p.CHOOSING:s.go("leaderboard");break;case p.VOTING:s.go("question")}}),e.$watchCollection("votes",function(a,t){e.gameData.phase==p.VOTING&&d(a)})}]),app.controller("questionController",["$scope","$window","cast",function(e,a,t){}]),app.controller("resultsController",["$scope","$timeout","$state","cast",function(e,a,t,n){e.labels=["Yes","No"],e.data=[],e.dataQuestion="";var s=function(){var a=_.last(e.lastQuestions);e.data=[a.yes,a.no],e.dataQuestion=a.question};a(function(){n.game.chooseRandomQuestioner(e.gameData,e.geteGamePhase())},1e4),e.$on("$destroy",function(){}),s()}]),angular.module("AskNCast.services",[]).service("cast",["$window","$rootScope","$q",function(e,a,t){this.game=null,this.appName="AskNCast";var n,s=this;this.SENDER_CONNECTED="sender-connected",this.SENDER_DISCONNECTED="sender-disconnected",this.PLAYER_AVAILABLE="player-available",this.PLAYER_QUIT="player-quit",this.PLAYER_DROPPED="player-dropped",this.GAME_MESSAGE_RECEIVED="game-message-received";var o=function(){n=e.cast.receiver.CastReceiverManager.getInstance();var t=new e.cast.receiver.CastReceiverManager.Config;t.statusText=s.appName+" ready.",t.maxInactivity=6e3;var o=new e.cast.receiver.games.GameManagerConfig;o.applicationName=s.appName,o.maxPlayers=10;var r=new e.cast.receiver.games.GameManager(o);s.game=new Game(r);var i=function(){s.game.run(function(){console.log(o.applicationName+" running."),r.updateGameStatusText(o.applicationName+" running.")})};n.onSenderConnected=function(e){a.$apply(function(){a.$broadcast(s.SENDER_CONNECTED,e)})},n.onSenderDisconnected=function(e){a.$apply(function(){a.$broadcast(s.SENDER_DISCONNECTED,e)})},r.addEventListener(cast.receiver.games.EventType.PLAYER_AVAILABLE,function(e){a.$apply(function(){a.$broadcast(s.PLAYER_AVAILABLE,e)})}),r.addEventListener(cast.receiver.games.EventType.PLAYER_QUIT,function(e){a.$apply(function(){a.$broadcast(s.PLAYER_QUIT,e)})}),r.addEventListener(cast.receiver.games.EventType.PLAYER_DROPPED,function(e){a.$apply(function(){a.$broadcast(s.PLAYER_DROPPED,e)})}),r.addEventListener(cast.receiver.games.EventType.GAME_MESSAGE_RECEIVED,function(e){a.$apply(function(){a.$broadcast(s.GAME_MESSAGE_RECEIVED,e)})}),n.onReady=function(e){i()},n.start(t)};this.boot=function(){"complete"===document.readyState?o():e.onload=o},this.finish=function(){n.stop()}}]).run(["cast",function(e){e.boot()}]);